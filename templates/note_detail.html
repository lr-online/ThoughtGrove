<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>笔记详情 - 拙园</title>
  <link rel="stylesheet" href="/static/css/styles.css">
  <link rel="manifest" href="/static/manifest.json">
  <link rel="icon" href="/static/images/favicon.ico">
  <meta name="theme-color" content="#536b57">
  <style>
    .page-container {
      display: flex;
      flex-direction: column;
      min-height: 100vh;
    }
    
    .detail-container {
      flex: 1;
      padding: var(--spacing-lg) 0;
    }
    
    .detail-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: var(--spacing-lg);
    }
    
    .detail-actions {
      display: flex;
      gap: var(--spacing-md);
    }
    
    .note-detail {
      background-color: white;
      border-radius: var(--radius-md);
      box-shadow: var(--shadow-md);
      padding: var(--spacing-xl);
      margin-bottom: var(--spacing-xl);
    }
    
    .note-title {
      font-family: var(--font-serif);
      font-size: 2rem;
      color: var(--color-primary);
      margin-bottom: var(--spacing-md);
      padding-bottom: var(--spacing-md);
      border-bottom: 1px solid #eee;
    }
    
    .note-meta {
      display: flex;
      flex-wrap: wrap;
      gap: var(--spacing-md);
      margin-bottom: var(--spacing-lg);
      font-size: 0.9rem;
      color: var(--color-secondary);
    }
    
    .note-content {
      line-height: 1.8;
      color: var(--color-dark);
      white-space: pre-wrap;
    }
    
    .loading-note {
      text-align: center;
      padding: var(--spacing-xxl) 0;
    }
    
    .loading-spinner {
      border: 3px solid rgba(0, 0, 0, 0.1);
      border-radius: 50%;
      border-top: 3px solid var(--color-primary);
      width: 40px;
      height: 40px;
      animation: spin 1s linear infinite;
      margin: 0 auto var(--spacing-md);
    }
    
    .error-message {
      text-align: center;
      color: var(--color-error);
      padding: var(--spacing-lg);
      background-color: rgba(158, 75, 55, 0.1);
      border-radius: var(--radius-md);
      margin-bottom: var(--spacing-lg);
      display: none;
    }
    
    .delete-modal {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0, 0, 0, 0.5);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 1000;
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.3s ease;
    }
    
    .delete-modal.is-active {
      opacity: 1;
      pointer-events: auto;
    }
    
    .modal-card {
      background-color: white;
      border-radius: var(--radius-md);
      padding: var(--spacing-lg);
      width: 90%;
      max-width: 500px;
      box-shadow: var(--shadow-lg);
    }
    
    .modal-header {
      margin-bottom: var(--spacing-md);
    }
    
    .modal-title {
      font-size: 1.5rem;
      color: var(--color-error);
    }
    
    .modal-body {
      margin-bottom: var(--spacing-lg);
    }
    
    .modal-actions {
      display: flex;
      justify-content: flex-end;
      gap: var(--spacing-md);
    }
    
    .note-back-button {
      color: var(--color-primary);
      display: inline-flex;
      align-items: center;
      margin-bottom: var(--spacing-md);
    }
    
    .note-back-button svg {
      margin-right: var(--spacing-xs);
    }
    
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    
    @media (max-width: 768px) {
      .detail-header {
        flex-direction: column;
        align-items: flex-start;
        gap: var(--spacing-md);
      }
      
      .detail-actions {
        width: 100%;
        justify-content: flex-start;
      }
      
      .note-detail {
        padding: var(--spacing-lg);
      }
      
      .note-title {
        font-size: 1.8rem;
      }
    }
  </style>
</head>
<body>
  <div class="page-container">
    <nav class="navbar">
      <div class="container navbar-container">
        <a href="/" class="navbar-brand">拙园</a>
        
        <div class="mobile-menu-toggle">
          <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <line x1="3" y1="12" x2="21" y2="12"></line>
            <line x1="3" y1="6" x2="21" y2="6"></line>
            <line x1="3" y1="18" x2="21" y2="18"></line>
          </svg>
        </div>
        
        <ul class="navbar-menu">
          <li class="navbar-item"><a href="/">笔记</a></li>
          <li class="navbar-item"><a href="#" id="logoutButton">退出</a></li>
        </ul>
      </div>
    </nav>
    
    <main class="detail-container">
      <div class="container">
        <a href="/" class="note-back-button">
          <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <path d="M19 12H5M12 19l-7-7 7-7"/>
          </svg>
          返回笔记列表
        </a>
        
        <!-- 加载状态 -->
        <div id="loadingNote" class="loading-note">
          <div class="loading-spinner"></div>
          <p>正在加载笔记...</p>
        </div>
        
        <!-- 错误消息 -->
        <div id="errorMessage" class="error-message"></div>
        
        <!-- 笔记详情 -->
        <div id="noteDetail" style="display: none;">
          <div class="detail-header">
            <h1 id="noteTitle" class="detail-title"></h1>
            
            <div class="detail-actions">
              <a id="editButton" href="#" class="btn btn-secondary">编辑笔记</a>
              <button id="deleteButton" class="btn btn-accent">删除笔记</button>
            </div>
          </div>
          
          <div class="note-detail">
            <h1 id="noteTitleDisplay" class="note-title"></h1>
            
            <div class="note-meta">
              <div>创建于 <span id="noteCreatedAt"></span></div>
              <div>更新于 <span id="noteUpdatedAt"></span></div>
            </div>
            
            <div id="noteContent" class="note-content"></div>
          </div>
        </div>
      </div>
    </main>
    
    <!-- 删除确认模态框 -->
    <div id="deleteModal" class="delete-modal">
      <div class="modal-card">
        <div class="modal-header">
          <h3 class="modal-title">确认删除</h3>
        </div>
        <div class="modal-body">
          <p>您确定要删除这篇笔记吗？此操作无法撤销。</p>
        </div>
        <div class="modal-actions">
          <button id="cancelDeleteButton" class="btn btn-secondary">取消</button>
          <button id="confirmDeleteButton" class="btn btn-accent">确认删除</button>
        </div>
      </div>
    </div>
    
    <footer class="site-footer">
      <div class="container footer-content">
        <div class="footer-brand">拙园</div>
        
        <div class="footer-nav">
          <a href="#" class="footer-link">关于</a>
          <a href="#" class="footer-link">隐私政策</a>
          <a href="#" class="footer-link">帮助</a>
        </div>
      </div>
    </footer>
  </div>
  
  <script src="/static/js/main.js"></script>
  <script>
    document.addEventListener('DOMContentLoaded', function() {
      // 检查用户是否已登录
      if (!auth.isAuthenticated()) {
        window.location.href = '/login';
        return;
      }
      
      // 获取DOM元素
      const loadingElement = document.getElementById('loadingNote');
      const errorElement = document.getElementById('errorMessage');
      const noteDetailElement = document.getElementById('noteDetail');
      const noteTitleElement = document.getElementById('noteTitleDisplay');
      const noteContentElement = document.getElementById('noteContent');
      const noteCreatedAtElement = document.getElementById('noteCreatedAt');
      const noteUpdatedAtElement = document.getElementById('noteUpdatedAt');
      const editButton = document.getElementById('editButton');
      const deleteButton = document.getElementById('deleteButton');
      const deleteModal = document.getElementById('deleteModal');
      const cancelDeleteButton = document.getElementById('cancelDeleteButton');
      const confirmDeleteButton = document.getElementById('confirmDeleteButton');
      
      // 获取笔记ID
      const urlParts = window.location.pathname.split('/');
      const noteId = urlParts[urlParts.length - 1];
      
      if (!noteId) {
        showError('无法加载笔记：缺少笔记ID');
        return;
      }
      
      // 加载笔记
      loadNote(noteId);
      
      // 删除按钮事件
      deleteButton.addEventListener('click', function() {
        deleteModal.classList.add('is-active');
      });
      
      // 取消删除按钮事件
      cancelDeleteButton.addEventListener('click', function() {
        deleteModal.classList.remove('is-active');
      });
      
      // 确认删除按钮事件
      confirmDeleteButton.addEventListener('click', async function() {
        try {
          const result = await notes.deleteNote(noteId);
          if (result) {
            window.location.href = '/';
          } else {
            throw new Error('删除失败');
          }
        } catch (error) {
          console.error('删除笔记失败:', error);
          showError('删除笔记失败，请重试');
          deleteModal.classList.remove('is-active');
        }
      });
      
      // 移动菜单切换
      const mobileMenuToggle = document.querySelector('.mobile-menu-toggle');
      const navbarMenu = document.querySelector('.navbar-menu');
      
      if (mobileMenuToggle && navbarMenu) {
        mobileMenuToggle.addEventListener('click', function() {
          navbarMenu.classList.toggle('is-active');
        });
      }
      
      // 注销按钮事件
      document.getElementById('logoutButton').addEventListener('click', function(e) {
        e.preventDefault();
        auth.logout();
      });
      
      // 加载笔记函数
      async function loadNote(id) {
        try {
          const note = await notes.getNote(id);
          
          if (!note) {
            showError('找不到指定的笔记');
            return;
          }
          
          // 设置编辑按钮链接
          editButton.href = `/notes/edit?id=${id}`;
          
          // 显示笔记内容
          noteTitleElement.textContent = note.title;
          noteContentElement.textContent = note.content;
          
          // 格式化日期
          const createdDate = new Date(note.created_at);
          const updatedDate = new Date(note.updated_at);
          
          noteCreatedAtElement.textContent = formatDate(createdDate);
          noteUpdatedAtElement.textContent = formatDate(updatedDate);
          
          // 隐藏加载状态，显示笔记详情
          loadingElement.style.display = 'none';
          noteDetailElement.style.display = 'block';
        } catch (error) {
          console.error('加载笔记失败:', error);
          showError('加载笔记失败，请重试');
        }
      }
      
      // 显示错误消息
      function showError(message) {
        loadingElement.style.display = 'none';
        errorElement.textContent = message;
        errorElement.style.display = 'block';
      }
      
      // 格式化日期
      function formatDate(date) {
        return date.toLocaleDateString('zh-CN', {
          year: 'numeric',
          month: 'long',
          day: 'numeric',
          hour: '2-digit',
          minute: '2-digit'
        });
      }
    });
  </script>
</body>
</html> 